<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="description" content="inlamemi">
<title>How to not use inlamemi • inlamemi</title>
<script src="../deps/jquery-3.6.0/jquery-3.6.0.min.js"></script><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<link href="../deps/bootstrap-5.3.1/bootstrap.min.css" rel="stylesheet">
<script src="../deps/bootstrap-5.3.1/bootstrap.bundle.min.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- bootstrap-toc --><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@v1.0.1/dist/bootstrap-toc.min.js" integrity="sha256-4veVQbu7//Lk5TSmc7YV48MxtMy98e26cf5MrgZYnwo=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.11/clipboard.min.js" integrity="sha512-7O5pXpc0oCRrxk8RUfDYFgn0nO1t+jLuIOQdOMRp4APB7uZ4vSjspzp5y6YDtDs4VzUSTbWzBFZ/LKJhnyFOKw==" crossorigin="anonymous" referrerpolicy="no-referrer"></script><!-- search --><script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/6.4.6/fuse.js" integrity="sha512-zv6Ywkjyktsohkbp9bb45V6tEMoWhzFzXis+LrMehmJZZSys19Yxf1dopHx7WzIKxr5tK2dVcYmaCk2uqdjF4A==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/autocomplete.js/0.38.0/autocomplete.jquery.min.js" integrity="sha512-GU9ayf+66Xx2TmpxqJpliWbT5PiGYxpaG8rfnBEk1LL8l1KGkRShhngwdXK1UgqhAzWpZHSiYPc09/NwDQIGyg==" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mark.js/8.11.1/mark.min.js" integrity="sha512-5CYOlHXGh6QpOFA/TeTylKLWfB3ftPsde7AnmhuitiTX4K5SqCLBeKro6sPS8ilsz1Q4NRx3v8Ko2IBiszzdww==" crossorigin="anonymous"></script><!-- pkgdown --><script src="../pkgdown.js"></script><meta property="og:title" content="How to not use inlamemi">
<meta property="og:description" content="inlamemi">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body>
    <a href="#main" class="visually-hidden-focusable">Skip to contents</a>
    

    <nav class="navbar fixed-top navbar-light navbar-expand-lg bg-light" data-bs-theme="light"><div class="container">
    
    <a class="navbar-brand me-2" href="../index.html">inlamemi</a>

    <small class="nav-text text-muted me-auto" data-bs-toggle="tooltip" data-bs-placement="bottom" title="">1.0.0</small>

    
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbar" aria-controls="navbar" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>

    <div id="navbar" class="collapse navbar-collapse ms-3">
      <ul class="navbar-nav me-auto">
<li class="active nav-item dropdown">
  <a href="#" class="nav-link dropdown-toggle" data-bs-toggle="dropdown" role="button" aria-expanded="false" aria-haspopup="true" id="dropdown-articles">Articles</a>
  <div class="dropdown-menu" aria-labelledby="dropdown-articles">
    <a class="dropdown-item" href="../articles/Framingham_heart_study.html">Influence of systolic blood pressure on coronary heart disease</a>
    <a class="dropdown-item" href="../articles/how_to_not_use_inlamemi.html">How to not use inlamemi</a>
    <a class="dropdown-item" href="../articles/modifying_default_plot.html">Modifying the default plot</a>
    <a class="dropdown-item" href="../articles/multiple_error_variables.html">Multiple variables with measurement error and missingness</a>
    <a class="dropdown-item" href="../articles/nhanes_survival.html">Survival data with repeated systolic blood pressure measurements</a>
    <a class="dropdown-item" href="../articles/simulated_examples.html">Simulated examples</a>
    <a class="dropdown-item" href="../articles/Visualize_model_structure.html">How are the models structured?</a>
  </div>
</li>
<li class="nav-item">
  <a class="nav-link" href="../reference/index.html">Reference</a>
</li>
      </ul>
<form class="form-inline my-2 my-lg-0" role="search">
        <input type="search" class="form-control me-sm-2" aria-label="Toggle navigation" name="search-input" data-search-index="../search.json" id="search-input" placeholder="Search for" autocomplete="off">
</form>

      <ul class="navbar-nav">
<li class="nav-item">
  <a class="external-link nav-link" href="https://github.com/emmaSkarstein/inlamemi/" aria-label="github">
    <span class="fab fa fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>

    
  </div>
</nav><div class="container template-article">




<div class="row">
  <main id="main" class="col-md-9"><div class="page-header">
      <img src="" class="logo" alt=""><h1>How to not use inlamemi</h1>
            
      
      <small class="dont-index">Source: <a href="https://github.com/emmaSkarstein/inlamemi/blob/HEAD/vignettes/how_to_not_use_inlamemi.Rmd" class="external-link"><code>vignettes/how_to_not_use_inlamemi.Rmd</code></a></small>
      <div class="d-none name"><code>how_to_not_use_inlamemi.Rmd</code></div>
    </div>

    
    
<div class="sourceCode" id="cb1"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va"><a href="https://emmaskarstein.github.io/inlamemi/">inlamemi</a></span><span class="op">)</span></span>
<span><span class="kw"><a href="https://rdrr.io/r/base/library.html" class="external-link">library</a></span><span class="op">(</span><span class="va">INLA</span><span class="op">)</span></span></code></pre></div>
<p>In this vignette, we show how to build the measurement error and
missingness models that <code>inlamemi</code> can fit, but without using
<code>inlamemi</code>. This is so that if you have a model that for some
reason does not work within <code>inlamemi</code>, you can see some
examples of how to fit these models “manually”.</p>
<p>There are two ways to structure the data for the models, the first
option is the one taken in <a href="https://arxiv.org/abs/1302.3065" class="external-link">Muff et al (2015)</a> and <a href="https://doi.org/10.1002/bimj.202300078" class="external-link">Skarstein et al
(2023)</a>, where the matrices are constructed directly by hand. The
other approach is the one that is used internally in
<code>inlamemi</code>, where we use the function
<code><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack()</a></code> to define the data structure for each
sub-model, and then join these together. This latter approach is a bit
more modular, and so this is the approach we will show here.</p>
<div class="section level2">
<h2 id="a-short-explanation-of-inla-stack-for-hierarchical-modelling">A short explanation of <code>inla.stack()</code> for hierarchical
modelling<a class="anchor" aria-label="anchor" href="#a-short-explanation-of-inla-stack-for-hierarchical-modelling"></a>
</h2>
<p>The <code><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack()</a></code> function is most commonly used for
spatial modelling with stochastic partial differential equations (SPDE),
since the data then is a bit more complex to structure. A description of
using stacks in that context can be found in <a href="https://becarioprecario.bitbucket.io/inla-gitbook/ch-spatial.html#spatial-models-using-stochastic-partial-differential-equations" class="external-link">chapter
7.3.3 of <em>Bayesian inference with INLA</em></a>. However, they can
also be quite useful when defining hierarchical models with multiple
likelihoods, which traditionally need to be defined by setting up
matrices where the structure of the matrices encode the structure of the
model, as explained in <a href="https://becarioprecario.bitbucket.io/inla-gitbook/ch-INLAfeatures.html#sec:sevlik" class="external-link">chapter
6.4 of <em>Bayesian inference with INLA</em></a>. The stacks are
eventually converted to these matrices by INLA, but for the modeller it
may be more convenient to define the model through the stacks. one
reason is that when setting up the matrices you need to know from the
beginning how many levels you will have in the model, since this
determines the number of columns in the matrices. However, with the
stacks, each model level has its own stack, and previous stacks do not
change if you add additional stacks. That is, the definition of stacks
for each model level can be done independently.</p>
<p>The <code>inla.stack</code> function takes four arguments:</p>
<ul>
<li>
<code>data</code>: a list of the data on the left side of the
formula (the response)</li>
<li>
<code>A</code>: a list of projector matrices, in our case for
non-spatial models this is just set to <code>list(1)</code>
</li>
<li>
<code>effects</code>: a list of the SPDE index and covariates, in
our case, just a list of a list containing the covariates and random
effects.</li>
<li>
<code>tag</code>: a character vector labelling this group, which can
be useful for extracting certain parts of the stack later.</li>
</ul>
</div>
<div class="section level2">
<h2 id="classical-and-berkson-measurement-error-and-missingness">Classical and Berkson measurement error and missingness<a class="anchor" aria-label="anchor" href="#classical-and-berkson-measurement-error-and-missingness"></a>
</h2>
<p>In the first example, we use the dataset <code>simple_data</code>,
generated in the vignette <a href="https://emmaskarstein.github.io/inlamemi/articles/simulated_examples.html">Simulated
examples</a>. This dataset has classical and Berkson measurement error,
and missing data, and so the main model we want to fit is</p>
<p><span class="math display">\[
  y_i = \beta_0 + \beta_x x_i + \beta_z z_i + \varepsilon_i,
\]</span> the Berkson measurement error is <span class="math display">\[
  0 = -x_{true, i} + r_i + u_{b,i},
\]</span> the classical measurement error model is <span class="math display">\[
  x_i = r_i + u_{c,i},
\]</span> and the imputation model is</p>
<p><span class="math display">\[
  0 = -r_i + \alpha_0 + \alpha_z z_i + \varepsilon_{r,i}.
\]</span></p>
<p>We begin by loading the data and defining the number of
observations.</p>
<div class="sourceCode" id="cb2"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">data</span> <span class="op">&lt;-</span> <span class="va">simple_data</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/nrow.html" class="external-link">nrow</a></span><span class="op">(</span><span class="va">data</span><span class="op">)</span></span></code></pre></div>
<p>Next, we define all the priors and initial values.</p>
<div class="sourceCode" id="cb3"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Prior for beta.x</span></span>
<span><span class="va">prior.beta</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span> <span class="co"># N(0, 10^3)</span></span>
<span></span>
<span><span class="co"># Priors for y, measurement error and true x-value precision</span></span>
<span><span class="va">prior.prec.y</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">9</span><span class="op">)</span></span>
<span><span class="va">prior.prec.u_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">9</span><span class="op">)</span></span>
<span><span class="va">prior.prec.u_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">9</span><span class="op">)</span></span>
<span><span class="va">prior.prec.r</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">9</span><span class="op">)</span></span>
<span></span>
<span><span class="co"># Initial values</span></span>
<span><span class="va">initial.prec.y</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">initial.prec.u_b</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">initial.prec.u_c</span> <span class="op">&lt;-</span> <span class="fl">1</span></span>
<span><span class="va">initial.prec.r</span> <span class="op">&lt;-</span> <span class="fl">1</span></span></code></pre></div>
<p>In <code>inlamemi</code>, we could then fit the model like this:</p>
<div class="sourceCode" id="cb4"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="co"># Fit the model</span></span>
<span><span class="va">simple_model</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/fit_inlamemi.html">fit_inlamemi</a></span><span class="op">(</span>data <span class="op">=</span> <span class="va">data</span>,</span>
<span>                           formula_moi <span class="op">=</span> <span class="va">y</span> <span class="op">~</span> <span class="va">x</span> <span class="op">+</span> <span class="va">z</span>,</span>
<span>                           formula_imp <span class="op">=</span> <span class="va">x</span> <span class="op">~</span> <span class="va">z</span>,</span>
<span>                           family_moi <span class="op">=</span> <span class="st">"gaussian"</span>,</span>
<span>                           error_type <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"berkson"</span>, <span class="st">"classical"</span><span class="op">)</span>,</span>
<span>                           prior.prec.moi <span class="op">=</span> <span class="va">prior.prec.y</span>,</span>
<span>                           prior.prec.berkson <span class="op">=</span> <span class="va">prior.prec.u_b</span>,</span>
<span>                           prior.prec.classical <span class="op">=</span> <span class="va">prior.prec.u_c</span>,</span>
<span>                           prior.prec.imp <span class="op">=</span> <span class="va">prior.prec.r</span>,</span>
<span>                           initial.prec.moi <span class="op">=</span> <span class="va">initial.prec.y</span>,</span>
<span>                           initial.prec.berkson <span class="op">=</span> <span class="va">initial.prec.u_b</span>,</span>
<span>                           initial.prec.classical <span class="op">=</span> <span class="va">initial.prec.u_c</span>,</span>
<span>                           initial.prec.imp <span class="op">=</span> <span class="va">initial.prec.r</span><span class="op">)</span></span></code></pre></div>
<p>If we instead want to do this without <code>inlamemi</code>, we start
by defining the stacks for each model level.</p>
<p>For the main regression model, we have the model <span class="math display">\[
  y_i = \beta_0 + \beta_x x_i + \beta_z z_i + \varepsilon_i,
\]</span> which is defined in a stack like this:</p>
<div class="sourceCode" id="cb5"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stk_moi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y_moi <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,</span>
<span>                      A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                      effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta.0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                             beta.x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                             beta.z <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      tag <span class="op">=</span> <span class="st">"moi"</span><span class="op">)</span></span></code></pre></div>
<p>Next, the Berkson measurement error model is <span class="math display">\[
  0 = -x_{true, i} + r_i + u_{b,i},
\]</span> and the corresponding stack is:</p>
<div class="sourceCode" id="cb6"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stk_b</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y_berkson <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                    effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id.x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                           weight.x <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>                           id.r <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                           weight.r <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    tag <span class="op">=</span> <span class="st">"berkson"</span><span class="op">)</span></span></code></pre></div>
<p>The classical measurement error model is <span class="math display">\[
  x_i = r_i + u_{c,i},
\]</span></p>
<p>and the stack is:</p>
<div class="sourceCode" id="cb7"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stk_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y_classical <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                    effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id.r <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                           weight.r <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    tag <span class="op">=</span> <span class="st">"classical"</span><span class="op">)</span></span></code></pre></div>
<p>Finally, the imputation model is <span class="math display">\[
  0 = -r_i + \alpha_0 + \alpha_z z_i + \varepsilon_{r,i}.
\]</span> and the corresponding stack is</p>
<div class="sourceCode" id="cb8"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stk_imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y_imp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                      effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id.r <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                             weight.r <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="op">-</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                             alpha.0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                             alpha.z <span class="op">=</span> <span class="va">data</span><span class="op">$</span><span class="va">z</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      tag <span class="op">=</span> <span class="st">"imputation"</span><span class="op">)</span></span></code></pre></div>
<p>We then stack these together, which will give us the matrix
formulation that we also could have specified manually.</p>
<div class="sourceCode" id="cb9"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stk_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span><span class="va">stk_moi</span>, <span class="va">stk_b</span>, <span class="va">stk_c</span>, <span class="va">stk_imp</span><span class="op">)</span></span></code></pre></div>
<p>For this model, we have two latent effects, <code>x</code> and
<code>r</code>, which are both specified in the formula. For further
details on the formula, see the supplementary material of <a href="https://doi.org/10.1002/bimj.202300078" class="external-link">Skarstein et al
(2023)</a>, which can be found online here: <a href="https://emmaskarstein.github.io/Missing-data-and-measurement-error/simulation_example.html" class="external-link uri">https://emmaskarstein.github.io/Missing-data-and-measurement-error/simulation_example.html</a></p>
<div class="sourceCode" id="cb10"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y_moi</span>, <span class="va">y_berkson</span>, <span class="va">y_classical</span>, <span class="va">y_imp</span><span class="op">)</span> <span class="op">~</span> <span class="op">-</span> <span class="fl">1</span> <span class="op">+</span> <span class="va">beta.0</span> <span class="op">+</span> <span class="va">beta.z</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">beta.x</span>, copy <span class="op">=</span> <span class="st">"id.x"</span>,</span>
<span>    hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>, fixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">id.x</span>, <span class="va">weight.x</span>, model <span class="op">=</span> <span class="st">"iid"</span>, values <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>    hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="op">-</span><span class="fl">15</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">id.r</span>, <span class="va">weight.r</span>, model<span class="op">=</span><span class="st">"iid"</span>, values <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>    hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="op">-</span><span class="fl">15</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">alpha.0</span> <span class="op">+</span> <span class="va">alpha.z</span></span></code></pre></div>
<p>Finally, we call the <code><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla()</a></code> function. This model
consists of four Gaussian sub-models, and in the
<code>control.family</code> argument we give the priors for each of
these.</p>
<div class="sourceCode" id="cb11"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_sim</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack.data</a></span><span class="op">(</span><span class="va">stk_full</span><span class="op">)</span>,</span>
<span>                  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gaussian"</span>, <span class="st">"gaussian"</span>, <span class="st">"gaussian"</span>, <span class="st">"gaussian"</span><span class="op">)</span>,</span>
<span>                  control.family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">initial.prec.y</span><span class="op">)</span>,</span>
<span>                                                  param <span class="op">=</span> <span class="va">prior.prec.y</span>,</span>
<span>                                                  fixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">initial.prec.u_b</span><span class="op">)</span>,</span>
<span>                                                  param <span class="op">=</span> <span class="va">prior.prec.u_b</span>,</span>
<span>                                                  fixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">initial.prec.u_c</span><span class="op">)</span>,</span>
<span>                                                  param <span class="op">=</span> <span class="va">prior.prec.u_c</span>,</span>
<span>                                                  fixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="va">initial.prec.r</span><span class="op">)</span>,</span>
<span>                                                  param <span class="op">=</span> <span class="va">prior.prec.r</span>,</span>
<span>                                                  fixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span></span>
<span>                  <span class="op">)</span>,</span>
<span>                  control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>compute <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_sim</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt;    c("inla.core(formula = formula, family = family, contrasts = contrasts, ", " data = data, quantiles = quantiles, E = E, </span></span>
<span><span class="co">#&gt;    offset = offset, ", " scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, ", " lp.scale = lp.scale, </span></span>
<span><span class="co">#&gt;    link.covariates = link.covariates, verbose = verbose, ", " lincomb = lincomb, selection = selection, control.compute = </span></span>
<span><span class="co">#&gt;    control.compute, ", " control.predictor = control.predictor, control.family = control.family, ", " control.inla = </span></span>
<span><span class="co">#&gt;    control.inla, control.fixed = control.fixed, ", " control.mode = control.mode, control.expert = control.expert, ", " </span></span>
<span><span class="co">#&gt;    control.hazard = control.hazard, control.lincomb = control.lincomb, ", " control.update = control.update, control.lp.scale </span></span>
<span><span class="co">#&gt;    = control.lp.scale, ", " control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, ", " inla.call = inla.call, </span></span>
<span><span class="co">#&gt;    inla.arg = inla.arg, num.threads = num.threads, ", " keep = keep, working.directory = working.directory, silent = silent, </span></span>
<span><span class="co">#&gt;    ", " inla.mode = inla.mode, safe = FALSE, debug = debug, .parent.frame = .parent.frame)" ) </span></span>
<span><span class="co">#&gt; Time used:</span></span>
<span><span class="co">#&gt;     Pre = 1.8, Running = 1.78, Post = 0.244, Total = 3.82 </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;          mean    sd 0.025quant 0.5quant 0.975quant  mode kld</span></span>
<span><span class="co">#&gt; beta.0  1.046 0.221      0.628    1.050      1.468 1.050   0</span></span>
<span><span class="co">#&gt; beta.z  1.945 0.392      1.256    1.955      2.658 1.951   0</span></span>
<span><span class="co">#&gt; alpha.0 1.033 0.051      0.934    1.033      1.132 1.033   0</span></span>
<span><span class="co">#&gt; alpha.z 2.025 0.052      1.922    2.025      2.127 2.025   0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;   Name     Model</span></span>
<span><span class="co">#&gt;     id.x IID model</span></span>
<span><span class="co">#&gt;    id.r IID model</span></span>
<span><span class="co">#&gt;    beta.x Copy</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model hyperparameters:</span></span>
<span><span class="co">#&gt;                                             mean    sd 0.025quant 0.5quant 0.975quant  mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations    1.113 0.356      0.540    1.071       1.92 0.995</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations[2] 1.125 0.359      0.597    1.066       2.00 0.955</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations[3] 0.928 0.112      0.722    0.923       1.16 0.916</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations[4] 0.977 0.126      0.757    0.968       1.25 0.946</span></span>
<span><span class="co">#&gt; Beta for beta.x                            1.974 0.202      1.587    1.970       2.38 1.954</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Marginal log-Likelihood:  -20700.01 </span></span>
<span><span class="co">#&gt;  is computed </span></span>
<span><span class="co">#&gt; Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span><span class="co">#&gt; (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</span></span></code></pre></div>
</div>
<div class="section level2">
<h2 id="a-model-for-missing-data-missing-not-at-random">A model for missing data, missing not at random<a class="anchor" aria-label="anchor" href="#a-model-for-missing-data-missing-not-at-random"></a>
</h2>
<p>In this example, dealing with only missing data, we show how to
include another level in the model to potentially capture how the
missingness mechanism may depend on available covariates.</p>
<p>In the dataset, simulated below, we let the value of the covariate
<code>x</code> with missingness depend on another covariate
<code>z1</code> (corresponding to the imputation model), while the
probability of an entry in <code>x</code> missing depends on another
covariate <code>z2</code> (corresponding to the missingness model).</p>
<div class="sourceCode" id="cb12"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="fu"><a href="https://rdrr.io/r/base/Random.html" class="external-link">set.seed</a></span><span class="op">(</span><span class="fl">2024</span><span class="op">)</span></span>
<span><span class="va">n</span> <span class="op">&lt;-</span> <span class="fl">1000</span></span>
<span></span>
<span><span class="va">z1</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="va">z2</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="fl">0</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">alpha.0</span> <span class="op">&lt;-</span> <span class="fl">1</span>; <span class="va">alpha.z1</span> <span class="op">&lt;-</span> <span class="fl">0.3</span></span>
<span><span class="va">x</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span>, mean <span class="op">=</span> <span class="va">alpha.0</span> <span class="op">+</span> <span class="va">alpha.z1</span><span class="op">*</span><span class="va">z1</span>, sd <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span></span>
<span><span class="va">gamma.0</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">1.5</span>; <span class="va">gamma.z2</span> <span class="op">&lt;-</span> <span class="op">-</span><span class="fl">0.5</span></span>
<span><span class="va">m_pred</span> <span class="op">&lt;-</span> <span class="va">gamma.0</span> <span class="op">+</span> <span class="va">gamma.z2</span><span class="op">*</span><span class="va">z2</span></span>
<span><span class="va">m_prob</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">m_pred</span><span class="op">)</span><span class="op">/</span><span class="op">(</span><span class="fl">1</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">exp</a></span><span class="op">(</span><span class="va">m_pred</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">m</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/logical.html" class="external-link">as.logical</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/stats/Binomial.html" class="external-link">rbinom</a></span><span class="op">(</span><span class="va">n</span>, <span class="fl">1</span>, prob <span class="op">=</span> <span class="va">m_prob</span><span class="op">)</span><span class="op">)</span></span>
<span><span class="va">x_obs</span> <span class="op">&lt;-</span> <span class="va">x</span></span>
<span><span class="va">x_obs</span><span class="op">[</span><span class="va">m</span><span class="op">]</span> <span class="op">&lt;-</span> <span class="cn">NA</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/sum.html" class="external-link">sum</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">x_obs</span><span class="op">)</span><span class="op">)</span><span class="op">/</span><span class="fu"><a href="https://rdrr.io/r/base/length.html" class="external-link">length</a></span><span class="op">(</span><span class="va">x_obs</span><span class="op">)</span></span>
<span><span class="co">#&gt; [1] 0.183</span></span>
<span></span>
<span><span class="va">beta.0</span> <span class="op">&lt;-</span> <span class="fl">1</span>; <span class="va">beta.x</span> <span class="op">&lt;-</span> <span class="fl">2</span>; <span class="va">beta.z1</span> <span class="op">&lt;-</span> <span class="fl">2</span>; <span class="va">beta.z2</span> <span class="op">&lt;-</span> <span class="fl">2</span></span>
<span><span class="va">y</span> <span class="op">&lt;-</span> <span class="va">beta.0</span> <span class="op">+</span> <span class="va">beta.x</span><span class="op">*</span><span class="va">x</span> <span class="op">+</span> <span class="va">beta.z1</span><span class="op">*</span><span class="va">z1</span> <span class="op">+</span> <span class="va">beta.z2</span><span class="op">*</span><span class="va">z2</span> <span class="op">+</span> <span class="fu"><a href="https://rdrr.io/r/stats/Normal.html" class="external-link">rnorm</a></span><span class="op">(</span><span class="va">n</span><span class="op">)</span></span>
<span></span>
<span><span class="va">missing_data</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/data.frame.html" class="external-link">data.frame</a></span><span class="op">(</span>y <span class="op">=</span> <span class="va">y</span>, x <span class="op">=</span> <span class="va">x_obs</span>, x_true <span class="op">=</span> <span class="va">x</span>, z1 <span class="op">=</span> <span class="va">z1</span>, z2 <span class="op">=</span> <span class="va">z2</span><span class="op">)</span></span></code></pre></div>
<p>The main model of interest is in this case <span class="math display">\[
y_i = \beta_0 + \beta_x x_{true,i} + \beta_{z_1} z_{1,i} + \beta_{z_2}
z_{2,i} + \varepsilon_i ,
\]</span> and the stack is:</p>
<div class="sourceCode" id="cb13"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stk_moi</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y_moi <span class="op">=</span> <span class="va">missing_data</span><span class="op">$</span><span class="va">y</span><span class="op">)</span>,</span>
<span>                      A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                      effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta.0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                             beta.x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                             beta.z1 <span class="op">=</span> <span class="va">missing_data</span><span class="op">$</span><span class="va">z1</span>,</span>
<span>                             beta.z2 <span class="op">=</span> <span class="va">missing_data</span><span class="op">$</span><span class="va">z2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      tag <span class="op">=</span> <span class="st">"moi"</span><span class="op">)</span></span></code></pre></div>
<p>The classical measurement error is just functioning as a link in this
case, but the model is <span class="math display">\[
  x_{obs, i} = x_{true, i} + u_{c,i},
\]</span> where the precision of <span class="math inline">\(u_{c,i}\)</span> is set to be very high for those
<span class="math inline">\(i\)</span> where <span class="math inline">\(x_{obs,i}\)</span> is observed. The stack for this
level is:</p>
<div class="sourceCode" id="cb14"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stk_c</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y_classical <span class="op">=</span> <span class="va">missing_data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span>,</span>
<span>                    A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                    effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                      <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id.x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                           weight.x <span class="op">=</span> <span class="fl">1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    tag <span class="op">=</span> <span class="st">"classical"</span><span class="op">)</span></span></code></pre></div>
<p>Next we have the imputation model <span class="math display">\[
  0 = -x_{true,i} + \alpha_0 + \alpha_{z_1} z_{1,i} + \varepsilon_{x,i},
\]</span> and the stack is</p>
<div class="sourceCode" id="cb15"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stk_imp</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y_imp <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">0</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                      effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>id.x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                             weight.x <span class="op">=</span> <span class="op">-</span><span class="fl">1</span>,</span>
<span>                             alpha.0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                             alpha.z1 <span class="op">=</span> <span class="va">missing_data</span><span class="op">$</span><span class="va">z1</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      tag <span class="op">=</span> <span class="st">"imputation"</span><span class="op">)</span></span></code></pre></div>
<p>The missingness model is a binomial model describing how the
probability of missing, <span class="math inline">\(p_m\)</span>, may
depend on other covariates. The model is <span class="math display">\[
  \text{logit}(p_{m,i}) = \gamma_0 + \gamma_x x_{true,i} + \gamma_{z_2}
z_{2,i},
\]</span> and the stack is:</p>
<div class="sourceCode" id="cb16"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stk_mis</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span>data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>y_mis <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/numeric.html" class="external-link">as.numeric</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/NA.html" class="external-link">is.na</a></span><span class="op">(</span><span class="va">missing_data</span><span class="op">$</span><span class="va">x</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      A <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                      effects <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                        <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>gamma.x <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>                             gamma.0 <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>,</span>
<span>                             gamma.z2 <span class="op">=</span> <span class="va">missing_data</span><span class="op">$</span><span class="va">z2</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                      tag <span class="op">=</span> <span class="st">"missingness"</span><span class="op">)</span></span></code></pre></div>
<p>We join the stacks together:</p>
<div class="sourceCode" id="cb17"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">stk_full</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack</a></span><span class="op">(</span><span class="va">stk_moi</span>, <span class="va">stk_c</span>, <span class="va">stk_imp</span>, <span class="va">stk_mis</span><span class="op">)</span></span></code></pre></div>
<p>In defining the formula, we now need to define the hyperparameter
<code>gamma.x</code>, the same way as we define <code>beta.x</code>.
This is a scaled copy of <code>id.x</code>.</p>
<div class="sourceCode" id="cb18"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">formula</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="va">y_moi</span>, <span class="va">y_classical</span>, <span class="va">y_imp</span>, <span class="va">y_mis</span><span class="op">)</span> <span class="op">~</span> <span class="op">-</span> <span class="fl">1</span> <span class="op">+</span></span>
<span>  <span class="va">beta.0</span> <span class="op">+</span> <span class="va">beta.z1</span> <span class="op">+</span> <span class="va">beta.z2</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">beta.x</span>, copy <span class="op">=</span> <span class="st">"id.x"</span>,</span>
<span>    hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>, fixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">id.x</span>, <span class="va">weight.x</span>, model <span class="op">=</span> <span class="st">"iid"</span>, values <span class="op">=</span> <span class="fl">1</span><span class="op">:</span><span class="va">n</span>,</span>
<span>    hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="op">-</span><span class="fl">15</span>, fixed <span class="op">=</span> <span class="cn">TRUE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/f.html" class="external-link">f</a></span><span class="op">(</span><span class="va">gamma.x</span>, copy <span class="op">=</span> <span class="st">"id.x"</span>,</span>
<span>    hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>beta <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">0</span>, <span class="fl">1</span><span class="op">/</span><span class="fl">1000</span><span class="op">)</span>, fixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span> <span class="op">+</span></span>
<span>  <span class="va">alpha.0</span> <span class="op">+</span> <span class="va">alpha.z1</span> <span class="op">+</span> <span class="va">gamma.0</span> <span class="op">+</span> <span class="va">gamma.z2</span></span></code></pre></div>
<p>Since we don’t have any measurement error in this case, we set the
precision to be very high for the classical error model in the argument
<code>scale</code>.</p>
<div class="sourceCode" id="cb19"><pre class="downlit sourceCode r">
<code class="sourceCode R"><span><span class="va">model_mnar</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.html" class="external-link">inla</a></span><span class="op">(</span><span class="va">formula</span>, data <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/pkg/INLA/man/inla.stack.html" class="external-link">inla.stack.data</a></span><span class="op">(</span><span class="va">stk_full</span><span class="op">)</span>,</span>
<span>                  family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="st">"gaussian"</span>, <span class="st">"gaussian"</span>, <span class="st">"gaussian"</span>, <span class="st">"binomial"</span><span class="op">)</span>,</span>
<span>                  scale <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">10</span><span class="op">^</span><span class="fl">8</span>, <span class="va">n</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span>, <span class="fu"><a href="https://rdrr.io/r/base/rep.html" class="external-link">rep</a></span><span class="op">(</span><span class="fl">1</span>, <span class="va">n</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  control.family <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span></span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                                                  param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">9</span><span class="op">)</span>,</span>
<span>                                                  fixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                                                  param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">9</span><span class="op">)</span>,</span>
<span>                                                  fixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>hyper <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>prec <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>initial <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/Log.html" class="external-link">log</a></span><span class="op">(</span><span class="fl">1</span><span class="op">)</span>,</span>
<span>                                                  param <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html" class="external-link">c</a></span><span class="op">(</span><span class="fl">10</span>, <span class="fl">9</span><span class="op">)</span>,</span>
<span>                                                  fixed <span class="op">=</span> <span class="cn">FALSE</span><span class="op">)</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                    <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span><span class="op">)</span><span class="op">)</span>,</span>
<span>                  control.predictor <span class="op">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html" class="external-link">list</a></span><span class="op">(</span>compute <span class="op">=</span> <span class="cn">TRUE</span>, link <span class="op">=</span> <span class="fl">1</span><span class="op">)</span></span>
<span><span class="op">)</span></span>
<span></span>
<span><span class="fu"><a href="https://rdrr.io/r/base/summary.html" class="external-link">summary</a></span><span class="op">(</span><span class="va">model_mnar</span><span class="op">)</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Call:</span></span>
<span><span class="co">#&gt;    c("inla.core(formula = formula, family = family, contrasts = contrasts, ", " data = data, quantiles = quantiles, E = E, </span></span>
<span><span class="co">#&gt;    offset = offset, ", " scale = scale, weights = weights, Ntrials = Ntrials, strata = strata, ", " lp.scale = lp.scale, </span></span>
<span><span class="co">#&gt;    link.covariates = link.covariates, verbose = verbose, ", " lincomb = lincomb, selection = selection, control.compute = </span></span>
<span><span class="co">#&gt;    control.compute, ", " control.predictor = control.predictor, control.family = control.family, ", " control.inla = </span></span>
<span><span class="co">#&gt;    control.inla, control.fixed = control.fixed, ", " control.mode = control.mode, control.expert = control.expert, ", " </span></span>
<span><span class="co">#&gt;    control.hazard = control.hazard, control.lincomb = control.lincomb, ", " control.update = control.update, control.lp.scale </span></span>
<span><span class="co">#&gt;    = control.lp.scale, ", " control.pardiso = control.pardiso, only.hyperparam = only.hyperparam, ", " inla.call = inla.call, </span></span>
<span><span class="co">#&gt;    inla.arg = inla.arg, num.threads = num.threads, ", " keep = keep, working.directory = working.directory, silent = silent, </span></span>
<span><span class="co">#&gt;    ", " inla.mode = inla.mode, safe = FALSE, debug = debug, .parent.frame = .parent.frame)" ) </span></span>
<span><span class="co">#&gt; Time used:</span></span>
<span><span class="co">#&gt;     Pre = 1.81, Running = 2.59, Post = 0.652, Total = 5.05 </span></span>
<span><span class="co">#&gt; Fixed effects:</span></span>
<span><span class="co">#&gt;            mean    sd 0.025quant 0.5quant 0.975quant   mode kld</span></span>
<span><span class="co">#&gt; beta.0    1.040 0.050      0.942    1.040      1.138  1.040   0</span></span>
<span><span class="co">#&gt; beta.z1   2.005 0.036      1.933    2.005      2.076  2.005   0</span></span>
<span><span class="co">#&gt; beta.z2   1.985 0.036      1.914    1.985      2.057  1.985   0</span></span>
<span><span class="co">#&gt; alpha.0   1.011 0.032      0.947    1.011      1.074  1.011   0</span></span>
<span><span class="co">#&gt; alpha.z1  0.292 0.033      0.228    0.292      0.355  0.292   0</span></span>
<span><span class="co">#&gt; gamma.0  -1.510 0.122     -1.754   -1.509     -1.275 -1.509   0</span></span>
<span><span class="co">#&gt; gamma.z2 -0.425 0.088     -0.597   -0.425     -0.252 -0.425   0</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Random effects:</span></span>
<span><span class="co">#&gt;   Name     Model</span></span>
<span><span class="co">#&gt;     id.x IID model</span></span>
<span><span class="co">#&gt;    beta.x Copy</span></span>
<span><span class="co">#&gt;    gamma.x Copy</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Model hyperparameters:</span></span>
<span><span class="co">#&gt;                                              mean    sd 0.025quant 0.5quant 0.975quant   mode</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations     0.984 0.048      0.891    0.983       1.08  0.982</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations[2]  1.127 0.358      0.574    1.077       1.97  0.984</span></span>
<span><span class="co">#&gt; Precision for the Gaussian observations[3]  1.023 0.047      0.933    1.023       1.12  1.021</span></span>
<span><span class="co">#&gt; Beta for beta.x                             1.954 0.035      1.886    1.953       2.02  1.952</span></span>
<span><span class="co">#&gt; Beta for gamma.x                           -0.035 0.089     -0.212   -0.035       0.14 -0.035</span></span>
<span><span class="co">#&gt; </span></span>
<span><span class="co">#&gt; Marginal log-Likelihood:  -11663.16 </span></span>
<span><span class="co">#&gt;  is computed </span></span>
<span><span class="co">#&gt; Posterior summaries for the linear predictor and the fitted values are computed</span></span>
<span><span class="co">#&gt; (Posterior marginals needs also 'control.compute=list(return.marginals.predictor=TRUE)')</span></span></code></pre></div>
<p>Looking at the summary, most importantly, note that the model picks
up <code>gamma.0</code> and <code>gamma.z2</code>, which were defined to
be -1.5 and -0.5, respectively. In the data simulation, we did not
construct the missingness of <code>x</code> to depend on the value of
<code>x</code>, which would correspond to a “missing not at random”
mechanism. The fact that the missingness of <code>x</code> depends on
other observed covariates indicates a “missing at random” mechanism (as
we simulated it to be). If the missingness of <code>x</code> did not
depend on any other covariates, it would be “missing completely at
random”.</p>
</div>
  </main><aside class="col-md-3"><nav id="toc"><h2>On this page</h2>
    </nav></aside>
</div>



    <footer><div class="pkgdown-footer-left">
  <p>Developed by Emma Skarstein, Stefanie Muff.</p>
</div>

<div class="pkgdown-footer-right">
  <p>Site built with <a href="https://pkgdown.r-lib.org/" class="external-link">pkgdown</a> 2.0.9.</p>
</div>

    </footer>
</div>

  

  

  </body>
</html>
